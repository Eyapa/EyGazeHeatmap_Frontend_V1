services:
  # --- SHARED BACKEND ---
  backend:
    build: ./backend
    image: eyapa/eyegazeheatmap:backend_v1
    container_name: eyegaze_backend
    ports:
      - "8000:8000" # Kept open for dev debugging
    env_file:
      - ./.env
    volumes:
      # Your existing dev volumes for hot-reloading data/logs
      - ./backend/db:/app/db
      - ./backend/data/heatmap_storage:/app/data/heatmap_storage
      - ./backend/data/logs:/app/data/logs
      - ./backend/data/models:/app/data/models
    environment:
      - DATABASE_URL=sqlite:///./db/database.db

  # --- LOCAL FRONTEND (Your Current Setup) ---
  frontend-local:
    profiles: ["local"]
    build:
      context: ./frontend
      args:
        - VITE_CONFIG_FILE=vite.config.prod.local.ts
        - NGINX_CONFIG_FILE=nginx.local.conf
    image: eyapa/eyegazeheatmap:frontend_local
    container_name: eyegaze_frontend_dev
    ports:
      - "80:80"
    depends_on:
      - backend
    volumes:
      - ./frontend/nginx.local.conf:/etc/nginx/conf.d/default.conf:ro

  # --- GLOBAL FRONTEND (For Public IP Deployment) ---
  frontend-global:
    profiles: ["global"]
    build:
      context: ./frontend
      args:
        - VITE_CONFIG_FILE=vite.config.prod.global.ts
        - NGINX_CONFIG_FILE=nginx.global.conf
    image: eyapa/eyegazeheatmap:frontend_global
    container_name: eyegaze_frontend_prod
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend
    volumes:
      # Production specific: No local code sync, just the SSL certs
      - ./ssl:/etc/nginx/ssl:ro